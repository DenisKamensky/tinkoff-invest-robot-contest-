### Пример использования Tinkoff investAPI v2 для алгоритмической торговли

# Описание

приложение созданно для алгоритмической торговли на основе стратегий

####  Для стабильной работы необходимо иметь: 
1. Node.js LTS версии ([>=16.15.0](https://nodejs.org/ ">=16.15.0"))
2.  Yarn (`npm i -g yarn` )
###### Возможен также запуск с помощью Docker (`docker-compose up -d`)

## Фичи
- Поддержка нескольких бирж
  1. Binance
  2. Alpaca
  3. Доступ к Московской и Санкт-Петербургской биржам через Tinkoff investAPI v2
- Хранение статистики торгов в файле `combined.log`
- Торговые стратегии создаются без привязки к конретным API и могут быть использованны на разных биржах
- Поддержка многопользовательского режима торгов
- Бектестинг стратегий с загрузкой исторических данных из файла / Tinkoff investAPI v2
- Typescript 
- Возможность проведения торгов в режимах песочницы / реальных торгов

Работа с Tinkoff investAPI построенна на основе [неофициального SDK для Tinkoff Invest APIv2 для nodejs](https://github.com/betslus1/unofficial-tinkoff-invest-api_v2-lazy-sdk-NODEJS "неофициального SDK для Tinkoff Invest APIv2 для nodejs")

## Предварительная настройка
### Режим Бектестинга стратегии
  для работы с приложением в режиме бектестинга установите следующие Environment переменные (можно сохранить их в файле .env)
`TINKOFF_TOKEN=токен для загрузки исторических данных`
`TINKOFF_ACCOUNT_ID=аккаунт для загрузки исторических данных`

**Важно!**
------------
  при загрузке большого объема данных из биржи (**больше 100 запросов в минуту**)
  запрос будет разделен на более мелкие запросы, которые будут выполненны с интервалом в одну минуту (чтобы не нарушать лимиты по unary запросам)
  сообщение о разделении запросов будет выведенно в консоль

------------


логика тестирования стратигии находится в файле **src/backtest.ts**

Получить данные для тестирования стратегии можно несколькими способами:
- **Загрузить их из биржи**
  для этого в файле  **src/backtest.ts** укажите следующие настройки
```
const SAVE_TO_FILE = null;

const LOAD_DATA_FROM = {
    ticker:  'TCS', // Тикер Акции
    /*
      интервал свечей для анализа
      возможные значения- 
      1m (1 минута)
      5m (5 минут)
      15m (15 минут)
      1h (1час)
      1d (1 день)
    */
  interval: '1d',
  to: '2022-01-01T00:14:18.113Z', // дата последней свечи ISOstring
  from: '2018-05-22T00:14:18.113Z' // дата первой свечи ISOstring
}; 

/* 
в методе loadCandlesData при необходимости укажите конфигурацию настройки свечей для работы внутри стратегии, либо оставьте значения без изменений
*/

  candlesConfig: {
  interval: loaderConfig.interval, // insert candles interval 1m | 5m | 15m | 1h | 1d
  limit: 20, // default candles quantity for request
}
```

после загрузки исторических данных будет создан экземпляр стратегии
и по окончанию ее тестирования сформируется отчет с результатами тестирования
- **Загрузить их из файла**
для этого укажите путь к json файлу
`const LOAD_DATA_FROM = path.resolve('report.json') `
файл  должен содержать массив свечей, реализующих интерфейс **ICandle** `src/entities/candle.ts`

- **Сохранить данные из биржи в файл**
для этого - повторите настройку так же как и для - ***Загрузки из биржи*** 
и укажите путь к файлу для сохранения без расширения
``const SAVE_TO_FILE = path.resolve('report')``
после сохранения файла запустите бектестинг в режиме чтения данных из этого файла


------------

после установки нужных данных для бектестинга 
запустите бектесстинг командой 
`npm run backtest`
по окончанию тестирования в тестирования будет показан отчет, с его результатами

# Режим торговли
подготовть файл
`trade-config.json`
Файл должен реализовывать интерфейс 
`src/entities/tradeConfig.ts`
пример настроек находится в
`trade-config.example.json`

в файле поддерживается торговля для разных API и разных пользователей
в поле **APIs** укажите настройки для тех api которые будут использованны для конкретного пользователя в настройках **TinkoffAPI** необходимо так же указать account_id чтобы избежать ситуации использования неверного счета при наличии саб-счетов

поле **pairs** содержит настройки необходимые для работы стратегии
( если это поле описывает конфиг для tinkoff api стоит добавить "makeType": "Shares", с уточнением типа ценной бумаги возможные варианты **Shares/Etfs/Futures/Bonds/**)


------------

Загрузите вашу торговую стратегию в файл 
`src/index.ts`
пример стратегии в этом файле -
`import trendDrivenStrategy from "./strategies/bollindgerBands";`


**Требования к стратегиям**
Торговая стратегия должна реализовывать интерфейс `src/utils/stateMachine/index.ts` и являться имплементацией патерна **'КОНЕЧНЫЙ АВТОМАТ'**
логика внутри стратегии реализованна переходом из одного состояния в другое,
набор состояний внутри стратиегий может быть произвольным, за исключением одного обязательного состояния **init** с методом **exec** см. пример в файле
`src/strategies/bollindgerBands/index.ts`


# Описание Примера торговой стратегии
для примера реализации торговых стратегий, в приложении реализованна стратигия основанная на работе индикатора технического анализа **Полосы Болинджера (Bollinger Bands)** стратегия находится в файле `src/strategies/bollindgerBands/index.ts`

стратегия работает по следующему алгоритму:
  1.  запрашивается набор свечей указзанный в конфигурации *trade-configs.json*
  2. при помощи функции std ([Standart Deviation](https://en.wikipedia.org/wiki/Standard_deviation "Standart Deviation")) строим корридор аномалий на основе скользящей средней ([Moving Average](https://en.wikipedia.org/wiki/Moving_average#:~:text=In%20statistics%2C%20a%20moving%20average,of%20finite%20impulse%20response%20filter. "Moving Average")) всех свечей из запроса, таким образом получаем верхнюю и нижню границы корридора аномалий
  3. ищем тренд для выставления ордера - если предпоследняя свеча пересекла нижнюю границу коридора - считаем что сейчас тренд на покупку и выставляем ордер на покупку, так же если предпоследняя свеча пересекла верхнюю границу корридора - считаем что это тренд на продажу, при наличии тренда, выставляем соответствующий ордер.  Считаем что трендовая ситуация возникает только тогда когда текущая свеча закрывается внутри корридора


**Чтобы запустить торговлю используйте команду**
`npm start`
